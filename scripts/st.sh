#!/usr/bin/env bash
set -euxo pipefail

BUILD_DIR=$1
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ST_DIR=$DIR/../st
CONFIG=$ST_DIR/config.h

source $DIR/common.sh

NAME=st
VERSION=0.8.4
SRC_FILENAME="st-$VERSION.tar.gz"
SRC_DIR="st-$VERSION"
SRC_URL="https://dl.suckless.org/st/$SRC_FILENAME"
SRC_CHECKSUM="d42d3ceceb4d6a65e32e90a5336e3d446db612c3fbd9ebc1780bc6c9a03346a6"

BOLD_IS_NOT_BRIGHT_FILENAME="bold-is-not-bright.diff"
BOLD_IS_NOT_BRIGHT_URL="https://st.suckless.org/patches/bold-is-not-bright/st-bold-is-not-bright-20190127-3be4cf1.diff"
BOLD_IS_NOT_BRIGHT_CHECKSUM="329169acac7ceaf901995d6e0897913089b799d8cd150c7f04c902f4a5b8eab2"

SCROLLBACK_FILENAME="scrollback.diff"
SCROLLBACK_URL="https://st.suckless.org/patches/scrollback/st-scrollback-20201205-4ef0cbd.diff"
SCROLLBACK_CHECKSUM="3b8c7d1815352cbfa2e100f6bb65e4c7d5a338952a6e7513b59a6a6297f32fb4"

SCROLLBACK_MOUSE_FILENAME="scrollback-mouse.diff"
SCROLLBACK_MOUSE_URL="https://st.suckless.org/patches/scrollback/st-scrollback-mouse-20191024-a2c479c.diff"
SCROLLBACK_MOUSE_CHECKSUM="319458d980195d18fa0f81a6898d58f8d046c5ff982ab872d741f54bb60e267d"

SCROLLBACK_MOUSE_ALTSCREEN_FILENAME="scrollback-mouse-altscreen.diff"
SCROLLBACK_MOUSE_ALTSCREEN_URL="https://st.suckless.org/patches/scrollback/st-scrollback-mouse-altscreen-20200416-5703aa0.diff"
SCROLLBACK_MOUSE_ALTSCREEN_CHECKSUM="cb87eb654985da46ff63663407184402393ad3d3013c8795570552fe56a15b9d"

mkdir -p $BUILD_DIR

echo "Working in $BUILD_DIR"
pushd $BUILD_DIR

get $SRC_URL $SRC_FILENAME
checksum $SRC_CHECKSUM $SRC_FILENAME

get $BOLD_IS_NOT_BRIGHT_URL $BOLD_IS_NOT_BRIGHT_FILENAME
checksum $BOLD_IS_NOT_BRIGHT_CHECKSUM $BOLD_IS_NOT_BRIGHT_FILENAME

get $SCROLLBACK_URL $SCROLLBACK_FILENAME
checksum $SCROLLBACK_CHECKSUM $SCROLLBACK_FILENAME

get $SCROLLBACK_MOUSE_URL $SCROLLBACK_MOUSE_FILENAME
checksum $SCROLLBACK_MOUSE_CHECKSUM $SCROLLBACK_MOUSE_FILENAME

get $SCROLLBACK_MOUSE_ALTSCREEN_URL $SCROLLBACK_MOUSE_ALTSCREEN_FILENAME
checksum $SCROLLBACK_MOUSE_ALTSCREEN_CHECKSUM $SCROLLBACK_MOUSE_ALTSCREEN_FILENAME

tar xvzf $SRC_FILENAME
patch -d $SRC_DIR -p1 < $BOLD_IS_NOT_BRIGHT_FILENAME
patch -d $SRC_DIR -p1 < $SCROLLBACK_FILENAME
patch -d $SRC_DIR -p1 < $SCROLLBACK_MOUSE_FILENAME
patch -d $SRC_DIR -p1 < $SCROLLBACK_MOUSE_ALTSCREEN_FILENAME
patch -d $SRC_DIR -p1 < $ST_DIR/usercflags.diff
patch -d $SRC_DIR -p1 < $ST_DIR/local.diff
ln -sf $CONFIG $(pwd)/$SRC_DIR
